# Streaming Test Demo - 使用说明

## 概述

这个Demo用于验证LaTeX数学公式流式传输时的渲染修复效果。它模拟实时接收Markdown内容（包含LaTeX表达式）的场景，验证应用程序不会因为不完整或无效的LaTeX表达式而冻结。

## 启动方式

### 方法1：从主窗口启动
1. 运行 `Markdig.Wpf.SampleApp` 项目
2. 点击工具栏上的 **"?? Streaming Test"** 按钮（橙色按钮）
3. 流式传输测试窗口会打开

### 方法2：直接启动
可以将 `StreamingTestWindow` 设置为启动窗口来直接打开。

## 功能说明

### 控制按钮

| 按钮 | 功能 | 说明 |
|------|------|------|
| **Start Streaming** | 开始流式传输 | 使用当前速度设置开始传输测试内容 |
| **Stop** | 停止传输 | 中断正在进行的流式传输 |
| **Clear** | 清空内容 | 清除所有显示的内容和统计信息 |
| **Fast** | 快速传输 | 设置速度为 10ms/字符，快速测试 |
| **Slow** | 慢速传输 | 设置速度为 200ms/字符，观察渲染过程 |

### 速度控制

- **滑块（Speed Slider）**: 调整每个字符的传输延迟
  - 最小值：10ms（快速）
  - 最大值：500ms（超慢，便于观察）
  - 默认值：50ms（推荐）

### 实时统计

| 指标 | 说明 |
|------|------|
| **Progress** | 显示传输进度百分比和进度条 |
| **Characters** | 显示已传输字符数 / 总字符数 |
| **Time** | 显示已用时间（秒） |
| **Status** | 显示当前状态（传输中/完成/错误/已停止） |

## 测试内容

测试内容包含：

### 1. 中文文本
验证Unicode字符的正确处理

### 2. LaTeX行内公式 `\(...\)`
```markdown
假设函数 \(f(x)\) 在点 \(a\) 处...
```

### 3. LaTeX块级公式 `\[...\]`
```markdown
\[
f(x) = f(a) + f'(a)(x-a) + \frac{f''(a)}{2!}(x-a)^2 + \cdots
\]
```

### 4. 复杂数学表达式
- 分数：`\frac{a}{b}`
- 求和：`\sum_{i=0}^{\infty}`
- 积分：`\int_{-\infty}^{\infty}`
- 上下标：`x^2`, `x_i`
- 根号：`\sqrt{x}`
- 希腊字母：`\alpha`, `\beta`, `\pi`

## 验证要点

### ? 成功标准

1. **应用程序不冻结**
   - 在整个流式传输过程中，UI保持响应
   - 可以随时点击"Stop"按钮停止传输

2. **不完整表达式的优雅处理**
   - 当LaTeX表达式未完成时（如 `\(f(x)` 没有 `\)`），应用不崩溃
   - 不完整的表达式显示为红色文本

3. **完整表达式正确渲染**
   - 当LaTeX表达式完整后，正确渲染为数学公式
   - 显示效果专业、清晰

4. **性能良好**
   - 即使快速传输（10ms/字符），也不应该有明显卡顿
   - 内存使用稳定，不应该有内存泄漏

### ? 失败情况（修复前）

修复前可能出现的问题：

1. **应用程序冻结**
- 遇到不完整的LaTeX表达式时，UI线程阻塞
   - 无法点击按钮，窗口无响应

2. **抛出异常**
   - 控制台显示：`Exception thrown: 'XamlMath.Exceptions.TexParseException'`
   - 可能导致应用崩溃

3. **渲染错误**
   - 公式显示异常或不显示

## 测试场景

### 场景1：正常速度测试（推荐）
1. 保持默认速度 50ms
2. 点击 "Start Streaming"
3. 观察公式逐步出现的过程
4. 验证所有公式最终正确渲染

**预期结果**：顺畅传输，公式正确显示

### 场景2：快速压力测试
1. 点击 "Fast" 按钮（10ms）
2. 点击 "Start Streaming"
3. 验证高速传输下应用的稳定性

**预期结果**：快速完成，无卡顿，无错误

### 场景3：慢速观察测试
1. 点击 "Slow" 按钮（200ms）
2. 点击 "Start Streaming"
3. 仔细观察每个字符添加时的渲染行为
4. 特别关注LaTeX表达式从不完整到完整的过程

**预期结果**：可以清楚看到红色文本（不完整表达式）转换为公式（完整表达式）

### 场景4：中断测试
1. 点击 "Start Streaming"
2. 在传输过程中点击 "Stop"
3. 验证能够立即停止

**预期结果**：立即停止，显示"已停止"状态

### 场景5：重复测试
1. 完成一次传输后
2. 点击 "Clear" 清空
3. 再次点击 "Start Streaming"
4. 重复多次

**预期结果**：每次都能正常工作，无内存泄漏

## 技术细节

### 流式传输模拟

```csharp
// 逐字符添加到StringBuilder
for (int i = 0; i < content.Length; i++)
{
    sb.Append(content[i]);
    
    // 每次添加后立即更新Markdown（触发解析和渲染）
    MarkdownViewer.Markdown = sb.ToString();
    
    // 延迟（模拟网络延迟）
    await Task.Delay(delayMs);
}
```

### 关键测试点

1. **不完整的LaTeX表达式**
   - 当遇到 `\(` 但还没有 `\)` 时
   - 当遇到 `\[` 但还没有 `\]` 时

2. **嵌套结构**
   - `\frac{a}{b}` 中的 `{a}` 可能先不完整

3. **特殊字符**
   - 反斜杠 `\`
   - 花括号 `{}`
   - 括号 `()`

## 故障排除

### 问题1：窗口无法打开
**解决方案**：
- 确保 `StreamingTestWindow.xaml` 和 `.xaml.cs` 都已正确添加到项目
- 重新编译项目

### 问题2：点击按钮无反应
**解决方案**：
- 检查事件处理器是否正确绑定
- 查看输出窗口的错误信息

### 问题3：内容不显示
**解决方案**：
- 检查 Pipeline 是否正确初始化
- 确认已调用 `UseSupportedExtensions()`

### 问题4：公式显示为红色文本
**可能原因**：
- LaTeX语法错误（这是正常的fallback行为）
- WPF-Math库未正确引用

## 性能基准

在标准PC上的参考数据：

| 速度设置 | 总字符数 | 预计完成时间 | 用途 |
|----------|----------|--------------|------|
| 10ms | ~3500 | ~35秒 | 压力测试 |
| 50ms | ~3500 | ~175秒 (3分钟) | 标准测试 |
| 100ms | ~3500 | ~350秒 (6分钟) | 详细观察 |
| 200ms | ~3500 | ~700秒 (12分钟) | 慢动作分析 |

## 扩展测试

### 自定义测试内容

可以修改 `StreamingTestWindow.xaml.cs` 中的 `TEST_CONTENT` 常量来测试其他内容：

```csharp
private const string TEST_CONTENT = @"
# Your Custom Test

Test inline math: \(E = mc^2\)

Test block math:
\[
\int_0^\infty e^{-x^2} dx = \frac{\sqrt{\pi}}{2}
\]
";
```

### 添加更多统计信息

可以在代码中添加更多监控：

```csharp
// 监控渲染时间
var renderStart = Stopwatch.StartNew();
MarkdownViewer.Markdown = sb.ToString();
var renderTime = renderStart.ElapsedMilliseconds;
```

## 总结

这个Demo提供了一个完整的测试环境来验证LaTeX数学公式流式传输的修复效果。通过不同速度、不同场景的测试，可以全面验证：

? **稳定性**：应用程序不会冻结或崩溃  
? **正确性**：LaTeX公式正确渲染  
? **性能**：即使高速传输也流畅运行  
? **容错性**：优雅处理不完整或错误的LaTeX表达式  

使用这个Demo，你可以直观地看到修复前后的差异，并确保流式传输场景下的用户体验得到改善。
